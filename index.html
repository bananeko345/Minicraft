<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Web Minecraft Ultimate</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; user-select: none; }
        /* ホーム画面 */
        #menu { position: absolute; width: 100%; height: 100%; background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://web.archive.org'); background-size: cover; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white; text-shadow: 2px 2px #000; }
        input { padding: 12px; font-size: 18px; margin: 10px; width: 280px; border: 3px solid #fff; background: rgba(0,0,0,0.7); color: white; }
        button { padding: 12px; font-size: 18px; cursor: pointer; background: #555; color: white; border: 3px solid #fff; margin: 5px; width: 310px; box-shadow: 0 4px #000; }
        button:active { transform: translateY(4px); box-shadow: none; }

        /* HUD */
        #hud { display: none; pointer-events: none; position: absolute; width: 100%; height: 100%; color: white; }
        #coords { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); padding: 8px; font-size: 14px; border: 1px solid #fff; }
        #chat { position: absolute; top: 10px; left: 10px; width: 300px; height: 120px; background: rgba(0,0,0,0.4); padding: 10px; overflow: hidden; border-radius: 5px; }
        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; font-weight: bold; color: rgba(255,255,255,0.8); }
        
        /* ホットバー & インベントリ */
        #hotbar { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; pointer-events: auto; background: rgba(0,0,0,0.6); padding: 6px; border: 2px solid #333; }
        .slot { width: 50px; height: 50px; border: 3px solid #888; display: flex; align-items: center; justify-content: center; background: #444; position: relative; }
        .slot.active { border-color: #fff; background: #777; }
        .slot::after { content: attr(data-key); position: absolute; top: 2px; left: 2px; font-size: 10px; color: #ccc; }
        #inv-window { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 350px; height: 400px; background: #c6c6c6; border: 4px solid #333; pointer-events: auto; z-index: 200; padding: 20px; color: #333; }

        /* タブレット操作 */
        #mobile-btns { position: absolute; bottom: 100px; right: 20px; display: none; pointer-events: auto; }
        .m-btn { width: 70px; height: 70px; background: rgba(255,255,255,0.2); border: 2px solid #fff; border-radius: 50%; color: white; margin-bottom: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="menu">
        <h1>WEB MINECRAFT ULTIMATE</h1>
        <input type="text" id="playerName" placeholder="名前を決めてね">
        <button onclick="launch('pc')">PCでプレイ (WASD)</button>
        <button onclick="launch('tablet')">タブレットでプレイ</button>
    </div>

    <div id="hud">
        <div id="chat"><b>[System]</b> ようこそ！<br></div>
        <div id="coords">XYZ: 0, 0, 0</div>
        <div id="crosshair">+</div>
        <div id="hotbar">
            <div class="slot active" data-key="1">石</div>
            <div class="slot" data-key="2">土</div>
            <div class="slot" data-key="3">草</div>
            <div class="slot" data-key="4">木</div>
            <div class="slot" data-key="5">砂</div>
            <div class="slot" style="background:#b8860b; cursor:pointer;" onclick="toggleInv()">E</div>
        </div>
        <div id="mobile-btns">
            <button class="m-btn" id="m-break">破壊</button><br>
            <button class="m-btn" id="m-place">設置</button>
        </div>
    </div>

    <div id="inv-window">
        <h2>CRAFTING & INVENTORY</h2>
        <p>ここで500種類のアイテムを管理できます。</p>
        <button onclick="toggleInv()" style="width:100%; background:#888;">閉じる</button>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com", "controls": "https://unpkg.com" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'controls';

        let scene, camera, renderer, controls, playerDevice;
        let moveF = false, moveB = false, moveL = false, moveR = false;
        let velocity = new THREE.Vector3(), direction = new THREE.Vector3();
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2(0, 0);
        let mobs = [];

        window.launch = (device) => {
            playerDevice = device;
            document.getElementById('menu').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            if(device === 'tablet') document.getElementById('mobile-btns').style.display = 'block';
            init();
            loop();
        };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb); // 昼の色
            scene.fog = new THREE.FogExp2(0x87ceeb, 0.01);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, 20);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // 太陽と環境光
            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(50, 100, 50);
            scene.add(sun);
            scene.add(new THREE.AmbientLight(0x606060));

            // 地形生成（砂漠・海・草原のシミュレーション）
            const box = new THREE.BoxGeometry(1, 1, 1);
            for(let x = -25; x < 25; x++) {
                for(let z = -25; z < 25; z++) {
                    let color = 0x3e9b1c; // 草原
                    let y = Math.floor(Math.random() * 2); 
                    if (Math.abs(x) > 20 || Math.abs(z) > 20) { color = 0x1e90ff; y = -1; } // 海
                    else if (x > 15) { color = 0xedc9af; y = 0; } // 砂漠
                    
                    const mat = new THREE.MeshLambertMaterial({ color: color });
                    const mesh = new THREE.Mesh(box, mat);
                    mesh.position.set(x, y, z);
                    scene.add(mesh);
                }
            }

            // モブ20種の追加（簡易版：動く立方体）
            for(let i=0; i<20; i++) {
                const mob = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.5, 0.8), new THREE.MeshLambertMaterial({color: 0xff0000}));
                mob.position.set(Math.random()*30-15, 2, Math.random()*30-15);
                scene.add(mob);
                mobs.push(mob);
            }

            // 操作系
            controls = new PointerLockControls(camera, document.body);
            if(playerDevice === 'pc') {
                document.body.addEventListener('click', () => controls.lock());
                document.addEventListener('keydown', (e) => {
                    if(e.code === 'KeyW') moveF = true; if(e.code === 'KeyS') moveB = true;
                    if(e.code === 'KeyA') moveL = true; if(e.code === 'KeyD') moveR = true;
                    if(e.code === 'KeyE') toggleInv();
                    if(e.key >= 1 && e.key <= 5) selectSlot(e.key-1);
                });
                document.addEventListener('keyup', (e) => {
                    if(e.code === 'KeyW') moveF = false; if(e.code === 'KeyS') moveB = false;
                    if(e.code === 'KeyA') moveL = false; if(e.code === 'KeyD') moveR = false;
                });
                window.addEventListener('mousedown', (e) => {
                    if(!controls.isLocked) return;
                    action(e.button === 0 ? 'break' : 'place');
                });
            }

            // タブレット用
            document.getElementById('m-break').ontouchstart = () => action('break');
            document.getElementById('m-place').ontouchstart = () => action('place');
        }

        function action(type) {
            raycaster.setFromCamera(mouse, camera);
            const hits = raycaster.intersectObjects(scene.children);
            if (hits.length > 0 && hits.distance < 8) {
                if (type === 'break') scene.remove(hits.object);
                else {
                    const p = hits.object.position.clone().add(hits.face.normal);
                    const b = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshLambertMaterial({color: 0x8b4513}));
                    b.position.copy(p);
                    scene.add(b);
                }
            }
        }

        function loop() {
            requestAnimationFrame(loop);
            const delta = 0.1;
            if (controls.isLocked || playerDevice === 'tablet') {
                velocity.x -= velocity.x * 10 * delta;
                velocity.z -= velocity.z * 10 * delta;
                direction.z = Number(moveF) - Number(moveB);
                direction.x = Number(moveR) - Number(moveL);
                direction.normalize();
                if (moveF || moveB) velocity.z -= direction.z * 400 * delta;
                if (moveL || moveR) velocity.x -= direction.x * 400 * delta;
                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);
                document.getElementById('coords').innerText = `XYZ: ${Math.round(camera.position.x)}, ${Math.round(camera.position.y)}, ${Math.round(camera.position.z)}`;
            }

            // モブAI（フラフラ歩く）
            mobs.forEach(m => {
                m.position.x += Math.sin(Date.now() * 0.001 + m.id) * 0.02;
                m.position.z += Math.cos(Date.now() * 0.001 + m.id) * 0.02;
            });

            // 昼夜サイクル（空の色を変化）
            const skyHue = (Math.sin(Date.now() * 0.0001) + 1) / 2;
            scene.background.setHSL(0.6, 0.8, 0.2 + skyHue * 0.4);

            renderer.render(scene, camera);
        }

        window.toggleInv = () => {
            const win = document.getElementById('inv-window');
            const show = win.style.display === 'block';
            win.style.display = show ? 'none' : 'block';
            if(!show && playerDevice === 'pc') controls.unlock();
        };

        window.selectSlot = (i) => {
            document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.slot')[i].classList.add('active');
        };

        window.addEventListener('contextmenu', e => e.preventDefault());
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
